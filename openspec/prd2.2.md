بسیار عالی، برویم سراغ بخش **ادغام (Integration)**. این یکی از حساس‌ترین بخش‌های پروژه شماست، چون باید به سایت‌های دیگر اجازه دهید با امنیت کامل از چت شما استفاده کنند بدون اینکه امنیت سرور اصلی شما به خطر بیفتد.

در اینجا مستندات فنی و نقشه راه برای بخش **External API & Widget** آورده شده است:

---

# ۱. استراتژی فنی ادغام (Integration Strategy)

ما از روش **"Iframe Widget"** استفاده می‌کنیم. چرا؟

* **ایزولاسیون:** استایل‌های سایت مقصد روی چت شما اثر نمی‌گذارد (و بالعکس).
* **امنیت:** کوکی‌ها و توکن‌های احراز هویت در محیط امن دامنه شما باقی می‌مانند.
* **راحتی:** سایت مقصد فقط با قرار دادن ۲ خط کد می‌تواند چت را فعال کند.

---

# ۲. مستندات API برای سایت‌های جانبی

### الف) اسکریپت لودر (The Loader Script)

شما یک فایل به نام `widget.js` در پوشه `public` خود می‌سازید. سایت مقصد این کد را قرار می‌دهد:

```html
<script src="https://your-chat-app.com/widget.js" data-site-id="UNIQUE_SITE_ID"></script>
<div id="chat-container"></div>

```

### ب) اندپوینت احراز هویت API

برای اینکه متوجه شویم پیام از کدام سایت می‌آید:

* **Endpoint:** `GET /api/v1/external/config`
* **Input:** `Site-Key` در هدر درخواست.
* **Output:** تنظیمات ظاهری چت (رنگ، عنوان، وضعیت قفل بودن).

---

# ۳. معماری پیام‌رسانی در سایت‌های خارجی (Sequence Diagram)

برای اینکه Iframe با سایت اصلی تعامل داشته باشد (مثلاً باز و بسته شدن خودکار)، از **Window.postMessage** استفاده می‌کنیم.

---

# ۴. ملاحظات امنیتی (Security & CORS)

* **Whitelist Domains:** در پنل ادمین، باید فیلدی داشته باشید که آدرس سایت‌هایی که اجازه دارند از چت شما استفاده کنند را وارد کنید.
* **CORS Policy:** سرور Next.js شما فقط باید به دامنه‌های ثبت شده اجازه درخواست بدهد.
* **Rate Limiting:** محدود کردن تعداد پیام‌های ارسالی از یک IP مشخص در سایت‌های خارجی برای جلوگیری از اسپم.

---

# ۵. ویژگی‌های پنل مدیریت برای API

ادمین باید در پنل اصلی خود بخش **"External Sites"** را داشته باشد:

1. **Site Management:** قابلیت افزودن نام دامنه (مثلاً `myshop.com`).
2. **API Key Generation:** تولید یک کلید اختصاصی برای هر سایت.
3. **Customization:** انتخاب رنگ تم (Primary Color) برای ویجت آن سایت خاص.

---

# ۶. سناریوی استفاده (Use Case: Guest Chat)

* **UC-ID:** UC-EXT-01
* **Title:** چت به عنوان مهمان در سایت خارجی
* **Description:** کاربر در سایت مقصد بدون داشتن اکانت در سیستم اصلی شما، پیام می‌فرستد.
* **Implementation:** سیستم به صورت خودکار یک `Guest_ID` در LocalStorage مرورگر کاربر ذخیره می‌کند تا تاریخچه چت او حفظ شود.

---

# ۷. Acceptance Criteria (تست پذیرش بخش API)

* [ ] ویجت چت در یک دامنه کاملاً متفاوت (مثلاً روی `localhost:5000`) بدون خطا لود شود.
* [ ] پیام‌های ارسالی از سایت خارجی، در پنل ادمین با برچسب "External Source" مشخص باشند.
* [ ] اگر دامنه‌ای در لیست سفید (Whitelist) نباشد، ویجت لود نشود.
* [ ] لایک و دیس‌لایک در حالت ویجت نیز به درستی کار کند.

---
