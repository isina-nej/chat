سلام. من به عنوان **Software Architect** و **Product Owner**، بر اساس اطلاعاتی که دادید، سند PRD این سیستم چت را تدوین کرده‌ام. این سند به گونه‌ای طراحی شده که نقشه راه شفافی برای پیاده‌سازی با Next.js و استقرار روی سرور شخصی فراهم کند.

---

# 1. Overview

این پروژه شامل یک پلتفرم چت بلادرنگ (Real-time) است که با **Next.js** ساخته می‌شود. سیستم دارای یک پنل مدیریت برای ادمین‌ها، یک رابط کاربری برای کاربران نهایی و یک ویجت/API جهت ادغام (Integration) در سایت‌های دیگر است.

* **Problem Statement:** نیاز به یک سیستم چت متمرکز و بومی که کنترل کامل داده‌ها را در اختیار داشته باشد و بتوان آن را به راحتی در سایر پلتفرم‌ها ادغام کرد.
* **Goal:** ایجاد یک زیرساخت ارتباطی امن با قابلیت ارسال فایل و مدیریت کاربران که بر روی سرور اختصاصی (Self-hosted) اجرا شود.

# 2. Scope & Out of Scope

* **In Scope:**
* سیستم احراز هویت (Login/Register) برای کاربران و ادمین‌ها.
* صفحه چت عمومی (Global Chat) برای ارتباطات بلادرنگ.
* قابلیت ارسال و نمایش تصاویر در چت.
* ارائه API یا اسکریپت جهت استفاده در سایت‌های خارجی.
* ذخیره‌سازی داده‌ها در دیتابیس لوکال (Self-managed).


* **Out of Scope:**
* تماس صوتی و تصویری.
* ویرایش پیام‌های ارسال شده.
* قابلیت ایجاد گروه‌های خصوصی متعدد (در این نسخه تمرکز بر چت کلی است).



# 3. User Personas & Use Cases

### Personas

1. **Admin:** مسئول نظارت بر گفتگوها و مدیریت کاربران.
2. **Standard User:** کاربرانی که در پلتفرم ثبت‌نام کرده و چت می‌کنند.
3. **External Site Visitor:** کاربرانی که از طریق API/Widget در سایت‌های دیگر پیام ارسال می‌کنند.

### Use Cases

* **UC-1: ارسال پیام و تصویر**
* **Description:** کاربر پیامی متنی یا تصویری را در چت‌روم ارسال می‌کند.
* **Pre-conditions:** کاربر باید لاگین کرده باشد.
* **Main Flow:** انتخاب فایل/تایپ متن -> فشردن دکمه ارسال -> آپلود در سرور -> پخش پیام برای همه کاربران آنلاین.


* **UC-2: ادغام در سایت دیگر (External API)**
* **Description:** نمایش چت‌باکس در یک سایت جانبی.
* **Post-conditions:** پیام‌های ارسالی از سایت خارجی در دیتابیس مرکزی ثبت می‌شوند.


* **UC-3: مدیریت کاربران توسط ادمین**
* **Description:** ادمین می‌تواند لیست کاربران را مشاهده یا دسترسی آن‌ها را محدود کند.



# 4. Functional Requirements

* **FR-1:** سیستم باید از **WebSockets** (مانند Socket.io) برای ارتباط دوطرفه آنی استفاده کند.
* **FR-2:** قابلیت ثبت‌نام با ایمیل و رمز عبور.
* **FR-3:** آپلود تصاویر باید در دیتابیس لوکال یا فایل‌سیستم سرور ذخیره و آدرس آن در دیتابیس ثبت شود.
* **FR-4:** ارائه یک Endpoint اختصاصی برای Fetch کردن پیام‌ها توسط سایت‌های خارجی.
* **FR-5:** نمایش وضعیت آنلاین/آفلاین بودن کاربران.

# 5. Non-Functional Requirements

* **Performance:** پیام‌ها باید در کمتر از ۲۰۰ میلی‌ثانیه به سایر کاربران آنلاین تحویل داده شوند.
* **Security:** رمزنگاری پسوردها (BCrypt) و استفاده از JWT برای احراز هویت API.
* **Reliability:** استفاده از سیستم Logging برای مانیتورینگ وضعیت سرور روی دیتابیس لوکال.
* **Storage:** محدودیت حجم برای تصاویر آپلودی جهت جلوگیری از پر شدن سریع هارد سرور.

# 6. Integration & API Hints

از آنجایی که از Next.js استفاده می‌کنید، سیستم به صورت **Full-stack** خواهد بود:

* **Database:** پیشنهاد می‌شود از **PostgreSQL** یا **SQLite** (برای لوکال بودن کامل) به همراه **Prisma ORM** استفاده کنید.
* **API Endpoints:**
* `POST /api/auth/register`: ثبت‌نام کاربر.
* `GET /api/messages`: دریافت تاریخچه پیام‌ها (با قابلیت Pagination).
* `POST /api/messages/upload`: اندپوینت مخصوص آپلود تصاویر.
* `GET /api/widget/config`: دریافت تنظیمات اولیه برای نمایش در سایت‌های دیگر.



# 7. Analytics & Success Metrics

* **Daily Active Users (DAU):** تعداد کاربران منحصربه‌فردی که روزانه پیام ارسال می‌کنند.
* **Average Response Time:** سرعت لود شدن پیام‌های قدیمی.
* **Uptime:** پایداری سرور و سوکت‌ها در بازه‌های زمانی طولانی.

# 8. Risks & Open Questions

* **Risk:** مصرف بالای منابع RAM در صورت افزایش تعداد کانکشن‌های WebSocket روی سرور لوکال.
* **Risk:** امنیت فایل‌های آپلود شده (نیاز به آنتی‌ویروس یا محدود کردن فرمت فایل‌ها).
* **Open Question:** آیا نیاز به ذخیره‌سازی دائمی تمام تصاویر است یا بعد از مدتی پاک شوند؟
* **Open Question:** نحوه مدیریت پهنای باند سرور هنگام ارسال تصاویر حجیم توسط چندین کاربر همزمان.

# 9. Acceptance Criteria

* کاربر بتواند در کمتر از ۱۰ ثانیه ثبت‌نام کرده و وارد چت شود.
* پیام‌های متنی و تصاویر بدون نیاز به رفرش صفحه برای سایرین نمایش داده شود.
* اسکریپت API به درستی در یک فایل HTML خام لود شده و چت را نمایش دهد.
* دیتابیس روی لوکال هاست (سرور خودتان) با موفقیت تمام داده‌ها را Persist کند.

---
بسیار عالی. به عنوان معمار سیستم، برای شروع فاز پیاده‌سازی، ساختار دیتابیس (Schema) و معماری ارتباطی را برای پروژه **Next.js** شما طراحی می‌کنم.

با توجه به اینکه دیتابیس باید **لوکال** باشد، استفاده از **PostgreSQL** به همراه **Prisma ORM** بهترین انتخاب است؛ چرا که مدیریت روابط بین ادمین‌ها، کاربران و پیام‌ها را بسیار ساده و استاندارد می‌کند.

---

### ۱. طراحی مدل داده‌ای (Prisma Schema)

این فایل قلب تپنده دیتابیس شماست. آن را در مسیر `prisma/schema.prisma` تعریف می‌کنیم:

```prisma
// مدل کاربران (ادمین و کاربر عادی)
model User {
  id            String   @id @default(cuid())
  email         String   @unique
  password      String
  name          String?
  role          Role     @default(USER) // ADMIN or USER
  messages      Message[]
  createdAt     DateTime @default(now())
}

enum Role {
  USER
  ADMIN
}

// مدل پیام‌ها
model Message {
  id        String   @id @default(cuid())
  content   String?  // متن پیام (اختیاری اگر فقط عکس باشد)
  imageUrl  String?  // آدرس تصویر ذخیره شده روی سرور
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  createdAt DateTime @default(now())
}

```

---

### ۲. معماری ارتباطی (Real-time Flow)

برای بخش چت آنی، چون از Next.js استفاده می‌کنید، باید یک سرور **Socket.io** در کنار API Routes خود داشته باشید.

**نحوه کارکرد:**

1. **Client:** پیام یا تصویر را به سرور می‌فرستد.
2. **Server:** ابتدا پیام را در دیتابیس لوکال ذخیره می‌کند.
3. **Broadcast:** سرور پیام را به تمام کلاینت‌های متصل (Socket.io) "Emit" می‌کند تا بدون رفرش، پیام ظاهر شود.

---

### ۳. ساختار پوشه‌بندی پیشنهادی (Next.js App Router)

برای اینکه پروژه از ابتدا تمیز پیش برود:

* `/app/api/auth`: مدیریت ثبت‌نام و لاگین (با NextAuth.js).
* `/app/api/upload`: هندل کردن آپلود تصاویر و ذخیره در پوشه `public/uploads`.
* `/app/chat`: صفحه اصلی چت.
* `/app/admin`: پنل مدیریت پیام‌ها و کاربران.
* `/components/ChatWidget.tsx`: کامپوننتی که قرار است در سایت‌های دیگر Embed شود.

---

### ۴. استراتژی API برای سایت‌های دیگر

برای اینکه سایت‌های دیگر بتوانند از چت شما استفاده کنند، دو راه دارید:

1. **Iframe:** یک صفحه ساده در Next.js بسازید که فقط شامل چت باشد و بقیه آن را در سایت خود با تگ `<iframe>` لود کنند. (امن‌ترین و راحت‌ترین روش)
2. **JS Widget:** یک فایل جاوااسکریپت ارائه دهید که یک `div` به صفحه هدف اضافه کرده و به API شما متصل شود.

---

### ۵. نکات کلیدی برای اجرا روی سرور شخصی

از آنجایی که فرمودید روی سرور خودتان ران می‌شود:

* **Process Manager:** حتماً از **PM2** برای بالا نگه داشتن اپلیکیشن استفاده کنید.
* **Reverse Proxy:** از **Nginx** استفاده کنید تا درخواست‌ها را به پورت Next.js (معمولاً ۳۰۰۰) هدایت کند و امنیت SSL را مدیریت کند.
* **Storage:** برای تصاویر، پوشه‌ای خارج از پوشه اصلی پروژه در نظر بگیرید تا با هر بار آپدیت کدها، عکس‌ها پاک نشوند.

