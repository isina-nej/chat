بسیار عالی. به عنوان **Product Owner**، این قابلیت‌های جدید را در قالب یک متمم برای PRD قبلی (نسخه ۱.۱) تدوین می‌کنم. این ویژگی‌ها سطح تعامل کاربران را بالا برده و کنترل ادمین بر فضای چت را کامل می‌کند.

---

# ۱. افزودنی‌های سطح دسترسی (Permissions)

در این نسخه، سه سطح دسترسی جدید تعریف می‌شود:

1. **Standard User:** فقط مدیریت پیام‌های خود (ویرایش/حذف).
2. **Moderator/Admin:** مدیریت کامل پیام‌های همه و کنترل وضعیت کاربران.
3. **Banned User:** کاربری که دسترسی ورود ندارد یا فقط چت‌ها را می‌بیند اما حق ارسال پیام ندارد.

# ۲. قابلیت‌های جدید کاربر (User Features)

### ویرایش و حذف پیام (Edit & Delete)

* **ویرایش:** کاربر می‌تواند متن پیام خود را تغییر دهد. پیامی که ویرایش شده باید با برچسب `(edited)` مشخص شود.
* **حذف:** کاربر می‌تواند پیام خود را برای همه (Delete for everyone) حذف کند. در دیتابیس، رکورد پیام یا کاملاً پاک می‌شود یا وضعیت آن به `isDeleted: true` تغییر می‌کند.

### تعاملات (Reactions)

* **لایک و دیس‌لایک:** هر کاربر می‌تواند روی هر پیام (حتی پیام بقیه) یک ری‌اکشن (Like/Dislike) ثبت کند.
* **قانون:** هر کاربر برای هر پیام فقط می‌تواند یک رای (یا مثبت یا منفی) ثبت کند.

# ۳. ابزارهای نظارتی ادمین (Moderation Tools)

### مدیریت پیام‌ها

* ادمین دسترسی مستقیم به حذف پیام‌های نامناسب از هر کاربری را دارد.

### مدیریت کاربران

* **Ban:** مسدود کردن کامل دسترسی کاربر به سیستم.
* **Mute (Restrict):** سلب اجازه ارسال پیام؛ کاربر می‌تواند پیام‌ها را بخواند اما فیلد Input برای او غیرفعال می‌شود.

### مدیریت روم (Chat Lock)

* ادمین می‌تواند وضعیت چت را به **Global Lock** تغییر دهد. در این حالت، فقط ادمین‌ها می‌توانند پیام بفرستند (مناسب برای اطلاعیه‌های مهم).

# ۴. مدل داده‌ای بروز شده (Updated Prisma Schema)

برای پیاده‌سازی این قابلیت‌ها، مدل‌های قبلی به شکل زیر تغییر می‌کنند:

```prisma
model User {
  // ... فیلدهای قبلی
  isBanned    Boolean  @default(false)
  canChat     Boolean  @default(true) // برای قابلیت Mute
}

model Message {
  // ... فیلدهای قبلی
  isEdited    Boolean  @default(false)
  isDeleted   Boolean  @default(false)
  likes       Like[]   // رابطه با جدول لایک‌ها
}

model Like {
  id        String   @id @default(cuid())
  type      LikeType // LIKE or DISLIKE
  userId    String
  messageId String
  user      User     @relation(fields: [userId], references: [id])
  message   Message  @relation(fields: [messageId], references: [id])

  @@unique([userId, messageId]) // هر کاربر برای هر پیام فقط یک ری‌اکشن
}

enum LikeType {
  LIKE
  DISLIKE
}

model SystemSettings {
  id         Int     @id @default(1)
  isChatLocked Boolean @default(false) // برای قفل کل چت توسط ادمین
}

```

# ۵. Functional Requirements (نسخه جدید)

* **FR-6:** سیستم باید پس از ویرایش پیام، نسخه جدید را بلافاصله از طریق سوکت به همه کلاینت‌ها اطلاع دهد.
* **FR-7:** دکمه‌های لایک/دیس‌لایک باید تعداد کل را در لحظه نشان دهند (Real-time count).
* **FR-8:** سیستم باید قبل از ارسال پیام توسط کاربر، وضعیت `isBanned` و `canChat` او را چک کند.
* **FR-9:** در صورت فعال بودن `isChatLocked` در دیتابیس، المنت `<input>` برای تمامی کاربران (بجز ادمین) باید غیرفعال (Disabled) شود.

# ۶. سناریوهای خاص (Edge Cases)

* **تغییر وضعیت همزمان:** اگر ادمین در لحظه‌ای که کاربر در حال تایپ است او را `Mute` کند، پیام ارسالی کاربر باید توسط سرور ریجکت شده و پیام خطا نمایش داده شود.
* **حذف پیام لایک شده:** اگر پیامی حذف شود، تمام لایک‌ها و دیس‌لایک‌های مربوط به آن نیز باید از دیتابیس پاک یا غیرفعال شوند.
* **ویرایش تصویر:** در این نسخه، فقط ویرایش متن مجاز است. برای تغییر عکس، کاربر باید پیام قبلی را حذف و عکس جدید آپلود کند.

# ۷. Acceptance Criteria (تست‌های پذیرش)

* [ ] ادمین بتواند با یک کلیک چت را برای همه قفل کند.
* [ ] کاربر بتواند ری‌اکشن خود را از لایک به دیس‌لایک تغییر دهد و تعداد مجموع درست بماند.
* [ ] پیام‌های حذف شده توسط ادمین، دیگر برای هیچ‌کدام از کاربران نمایش داده نشود.
* [ ] کاربران مسدود شده (Banned) نتوانند لاگین کنند.

---
