بسیار عالی، حالا به سراغ بخش حیاتی پروژه یعنی **نحوه ادغام (Integration)** و **امنیت زیرساخت** می‌رویم. این مرحله مشخص می‌کند که چطور سایت‌های دیگر می‌توانند از چت شما استفاده کنند و شما چطور این سیستم را روی سرور خود مدیریت می‌کنید.

---

# ۱. استراتژی ادغام در سایت‌های دیگر (The Widget)

برای اینکه سرویس چت شما در سایت‌های دیگر قابل استفاده باشد، از متد **JS Injection** استفاده می‌کنیم.

### نحوه عملکرد:

1. **اسکریپت کلاینت:** شما یک فایل `widget.js` در پوشه `public` پروژه Next.js خود می‌سازید.
2. **نصب در سایت مقصد:** ادمین سایت دیگر، کد زیر را در انتهای تگ `<body>` خود قرار می‌دهد:
```html
<script src="https://your-domain.com/widget.js" data-room-id="global"></script>

```



### جزئیات فنی ویجت:

* **ایجاد المنت:** اسکریپت به صورت خودکار یک `iframe` یا یک `div` شناور در گوشه پایین سمت راست سایت مقصد ایجاد می‌کند.
* **ارتباط Cross-Origin:** برای امنیت، باید هدرهای **CORS** را در Next.js طوری تنظیم کنید که فقط دامنه‌های مجاز (یا همه دامنه‌ها در صورت عمومی بودن) بتوانند به API متصل شوند.

---

# ۲. معماری مدیریت فایل و تصاویر (Local Storage)

از آنجایی که دیتابیس و سرور لوکال است، نباید فشار آپلود مستقیم روی دیتابیس باشد.

* **ذخیره‌سازی:** تصاویر در پوشه `public/uploads` ذخیره می‌شوند.
* **بهینه‌سازی:** پیشنهاد می‌شود از کتابخانه **Sharp** در Next.js استفاده کنید تا عکس‌ها قبل از ذخیره شدن، فشرده شوند (WebP format) تا هارد سرور سریع پر نشود.

---

# ۳. مدیریت پنل ادمین (Admin Dashboard)

ادمین برای اعمال مواردی که در PRD قبلی ذکر شد (Ban, Mute, Lock)، نیاز به یک داشبورد اختصاصی دارد:

* **مشاهده مانیتورینگ:** لیست پیام‌های اخیر و تعداد کاربران آنلاین (از طریق Socket.io Room Size).
* **دکمه‌های کنترلی:**
* `Toggle Chat Lock`: تغییر وضعیت متغیر `isChatLocked` در دیتابیس.
* `User List`: جدولی شامل نام کاربر، وضعیت (Active/Banned) و دکمه‌هایی برای تغییر وضعیت.


* **گزارش لایک‌ها:** مشاهده اینکه کدام پیام‌ها بیشترین تعامل (Like/Dislike) را داشته‌اند.

---

# ۴. امنیت و محدودیت‌ها (Rate Limiting)

برای جلوگیری از اسپم (Spam) و حملات DOS به سرور لوکال شما:

* **Rate Limit:** هر کاربر مجاز است در هر ۱۰ ثانیه حداکثر ۵ پیام ارسال کند.
* **Image Filter:** محدود کردن آپلود به فرمت‌های `jpg, png, webp` و حداکثر حجم ۲ مگابایت.
* **JWT Protection:** تمام درخواست‌های API (ادیت، حذف، لایک) باید هدر `Authorization` شامل توکن کاربر را داشته باشند.

---

# ۵. نقشه راه پیاده‌سازی (Roadmap)

| فاز | تمرکز | خروجی کلیدی |
| --- | --- | --- |
| **فاز ۱** | زیرساخت | راه‌اندازی Next.js + Prisma + Postgres (Local) |
| **فاز ۲** | ارتباطات | پیاده‌سازی Socket.io برای چت بلادرنگ |
| **فاز ۳** | ویژگی‌های پیشرفته | قابلیت ادیت، حذف و سیستم لایک/دیس‌لایک |
| **فاز ۴** | ادمین و امنیت | پنل مدیریت، سیستم Ban/Mute و Rate Limiter |
| **فاز ۵** | توزیع | ساخت `widget.js` برای استفاده در سایت‌های خارجی |

---

# ۶. سوالات فنی باز (Open Questions)

۱. **احراز هویت در سایت‌های خارجی:** آیا کاربران سایت‌های دیگر باید در سیستم شما اکانت بسازند یا می‌خواهید از سیستم "کاربر مهمان" (Guest) استفاده کنید؟
۲. **ذخیره پیام‌ها:** آیا نیاز به آرشیو کردن پیام‌های قدیمی (مثلاً پیام‌های قدیمی‌تر از ۶ ماه) در یک فایل مجزا دارید تا سرعت دیتابیس کم نشود؟
